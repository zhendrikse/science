<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
      }
    }
</script>

<canvas id="myCanvas" class="applicationCanvas"></canvas>

<script type="module">
    import { Group, Vector3, Scene, Color, PerspectiveCamera, WebGLRenderer, HemisphereLight, DirectionalLight } from "three";
    import { Spring, Ball, Graph } from 'https://www.hendrikse.name/science/js/three-js-extensions.js';
    import {OrbitControls} from "three/addons/controls/OrbitControls.js";

    // --- Scene setup ---
    const canvas = document.getElementById("myCanvas");
    const scene = new Scene();
    scene.background = new Color(0x131313);

    const g = 9.8; // gravitational constant

    const camera = new PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
    camera.position.set(20, 20, 20);
    camera.lookAt(0, 0, 0);

    const renderer = new WebGLRenderer({canvas, antialias:true});
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);

    scene.add(new HemisphereLight(0xffffff, 0x222222, 0.6));
    const dirLight = new DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(10, 20, 10);
    scene.add(dirLight);
    renderer.shadowMap.enabled = true;
    dirLight.castShadow = true;

    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;

    export class HarmonicOscillator extends Group {
        constructor({ damping = 0.2 } = {}) {
            super();
            this._masses = [];
            this._springs = [];
            this._damping = damping;
        }

        withMassAt(position, {color = "yellow"} = {}) {
            this._masses.push(new Ball(this, {position: position, color: color}));
            return this;
        }

        withSpringBetween(i, j, {color = "white"} = {}) {
            const spring = new Spring(
                this,
                this._masses[i].position(),
                this._masses[j].position().clone().sub(this._masses[i].position()),
                {color: color}
            );
            this._springs.push({ spring, i, j });
            return this;
        }

        update(dt=0.01) {
            const forces = this._masses.map(() => new Vector3(0, 0, 0));

            for (const { spring, i, j } of this._springs) {
                const ball1 = this._masses[i];
                const ball2 = this._masses[j];

                const axis = ball2.position().clone().sub(ball1.position());
                const direction = axis.clone().normalize();

                spring.updateAxis(axis);
                spring.updatePosition(ball1.position());

                const springForce = direction.multiplyScalar(spring.force());
                const relVelocity = ball2.velocity().clone().sub(ball1.velocity());
                const dampingForce = relVelocity.projectOnVector(direction).multiplyScalar(this._damping);

                springForce.add(dampingForce);

                forces[i].add(springForce);
                forces[j].add(springForce.clone().negate());
            }

            this._masses.forEach((ball, index) => ball.semiImplicitEulerUpdate(forces[index], dt));
        }
    }

    const worldGroup = new Group();
    scene.add(worldGroup);

    const massSpringSystem = new HarmonicOscillator({damping: 0.5})
        .withMassAt(new Vector3(-25, 0, 0), {color: "red"})
        .withMassAt(new Vector3(-15, 0, 0))
        .withMassAt(new Vector3(-5, 0, 0))
        .withMassAt(new Vector3( 5, 0, 0))
        .withMassAt(new Vector3( 15, 0, 0), {color: "red"})
        .withSpringBetween(0, 1)
        .withSpringBetween(1, 2)
        .withSpringBetween(2, 3)
        .withSpringBetween(3, 4);
    worldGroup.add(massSpringSystem);

    massSpringSystem._masses[4].moveTo(new Vector3(11, 0, 0));

    function animate() {
        requestAnimationFrame(animate);
        massSpringSystem.update();
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

</script>

