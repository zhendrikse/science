<style>
.applicationCanvas {
display: block;
background-color: #131313;
width: 100%;
max-width: 800px;
aspect-ratio: 4 / 3;
margin: auto;
}

.canvasWrapper {
position: relative;
width: 100%;
max-width: 800px;
margin: 0 auto;
aspect-ratio: 4 / 3;
}

.guiContainer {
margin-top: 0.5em;
background: #1a1a1a;
}

</style>
<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
      }
    }
</script>

<div class="canvasWrapper" id="scalarContainer">
    <canvas class="applicationCanvas" id="scalarCanvas"></canvas><br/>
</div>
<div id="gui-container"></div>

<script type="module">
    import * as THREE from "three";
    import { Range, Axes, MatlabAnnotations, MatlabAxesLayout }
        from 'https://www.hendrikse.name/science/js/three-js-extensions.js';
    import { GUI } from "three/addons/libs/lil-gui.module.min.js";

    const canvasContainer = document.getElementById("scalarContainer");
    const canvas = document.getElementById("scalarCanvas");

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x131313);
    const worldGroup = new THREE.Group();
    scene.add(worldGroup);

    const params = {
        axesParameters: new AxesParameters({axesLabels: false}),
        opacity: 0.3,
        radius: 0.1
    };

    class ControlsGui {
        constructor(axesLayout, annotations) {
            const gui = new GUI({width: 300, autoPlace: false});

            const axesFolder = gui.addFolder("Axes");
            axesFolder.add(params.axesParameters, 'axesLines')
                .name("Axes").onChange(value => value ? axesLayout.showAxes() : axesLayout.hideAxes());
            axesFolder.add(params.axesParameters, 'axesLabels')
                .name("Axes labels").onChange(value => annotations.visible = value);
            axesFolder.add(params.axesParameters, 'xyPlane')
                .name("XY plane").onChange(value => value ? axesLayout.showXY() : axesLayout.hideXY());
            axesFolder.add(params.axesParameters, 'xzPlane')
                .name("XZ plane").onChange(value => value ? axesLayout.showXZ() : axesLayout.hideXZ());
            axesFolder.add(params.axesParameters, 'yzPlane')
                .name("YZ plane").onChange(value => value ? axesLayout.showYZ() : axesLayout.hideYZ());
            axesFolder.close();

            gui.add(params, "opacity", 0, 1, .01).name("Opacity").onChange(value => field.setOpacity(value));
            gui.add(params, "radius", 0, 1, .01).name("Radius").onFinishChange(value => field.setRadius(value));

            document.getElementById("gui-container").appendChild(gui.domElement);
        }
    }

    class Scalar {
        constructor(position, radius, opacity, value) {
            this.position = position;
            this.value = value;
            const geometry = new THREE.SphereGeometry(radius, 12, 12);
            const material = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: opacity
            });
            this.sphere = new THREE.Mesh(geometry, material);
            this.sphere.position.copy(position);
        }

        setColor(color) { this.sphere.material.color.set(color); }
        setOpacity(value) { this.sphere.material.opacity = value; }
        setRadius(radius) {
            this.sphere.geometry.dispose();
            this.sphere.geometry = new THREE.SphereGeometry(radius, 12, 12);
        }
    }

    class ScalarField {
        constructor(range, func) {
            this.scalars = [];
            this.opacity = 0.3;

            for (const x of range)
                for (const y of range)
                    for (const z of range) {
                        const position = new THREE.Vector3(x, y, z);
                        const value = func(position);
                        const scalar = new Scalar(position, range.stepSize *.25, this.opacity, value);
                        scalar.setColor(this._colorFor(value));
                        this.scalars.push(scalar);
                    }
        }

        _colorFor = (value) =>
            new THREE.Color(Math.min(1, value * 2), Math.min(1, 1 - value), Math.min(1, 1 - .5 * value));
        setOpacity(v) { this.opacity = v; this.scalars.forEach(s => s.setOpacity(v)); }
        setRadius(r) { this.scalars.forEach(s => s.setRadius(r/4)); }
    }

    const field = new ScalarField(new Range(-3, 3, .4), pos => Math.exp(-0.3 * pos.lengthSq()));
    field.scalars.forEach(s => scene.add(s.sphere));

    // Axes
    const axes = new Axes();
    worldGroup.add(axes);
    const axesLayout = new MatlabAxesLayout(8, 10);
    const annotations = new MatlabAnnotations(canvasContainer, axesLayout);
    axes.setLayout(axesLayout);
    axes.setAnnotations(annotations);
    worldGroup.add(annotations);
    annotations.visible = params.axesParameters.axesLabels;
    axes.shiftBy(new THREE.Vector3(0, -4, 0));

    const plot3D = new Plot3D(canvas, scene, axes);
    const bbox = new THREE.Box3();
    bbox.setFromObject( worldGroup );
    plot3D.fitToBoundingBox(bbox, {padding: 1.0, translationY: -4});

    const gui = new ControlsGui(axesLayout, annotations);

    let time = 0;
    const kappa = 0.3;

    // Temperature at center
    function temperatureAt(position, t) {
        const rSquared = position.lengthSq();
        return Math.exp(-rSquared / (4 * kappa * t));
    }

    // Temperature on edge
    // const source = new THREE.Vector3(3, 0, 0);
    // function temperatureAt(pos, t) {
    //     const r2 = pos.clone().sub(source).lengthSq();
    //     return Math.exp(-r2 / (4 * kappa * t));
    // }

    function animate() {
        requestAnimationFrame(animate);

        time += 0.02;

        field.scalars.forEach((scalar) => {
            const T = temperatureAt(scalar.position, time + 0.05);
            scalar.setColor(field._colorFor(T));
        });

        plot3D.render();
    }
    animate();
</script>
