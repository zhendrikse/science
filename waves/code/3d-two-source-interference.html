<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
      }
    }
</script>

<div class="canvasWrapper" id="3dInterferenceWrapper">
    <canvas class="applicationCanvas" id="3dInterferenceCanvas"></canvas><br/>
</div>
<div id="gui-container"></div>

<script type="module">
    import { Scene, Group } from "three";
    import { AxesController, ThreeJsUtils, Plot3DView, AxesParameters }
        from 'https://www.hendrikse.name/science/js/three-js-extensions.js';
    import { GUI } from "three/addons/libs/lil-gui.module.min.js";
    import { SurfaceController, ViewParameters, ContourType, TangentFrameParameters, ContourParameters,
        HeightColorMapper, SurfaceSpecification, DefaultSurfaceDefinition, Surface}
        from 'https://www.hendrikse.name/science/js/3d-surface-components.js';

    const canvasContainer = document.getElementById("3dInterferenceWrapper");
    const canvas = document.getElementById("3dInterferenceCanvas");

    const scene = new Scene();
    const worldGroup = new Group();
    scene.add(worldGroup);

    const waveParams = {
        distance: 20,
        waveLength: 4,
        intensity: 2,
        phase: 0
    };

    const domain = 50;
    const d1 = (u, v) => Math.sqrt((u - waveParams.distance / 2) * (u - waveParams.distance / 2) + v * v);
    const d2 = (u, v) => Math.sqrt((u + waveParams.distance / 2) * (u + waveParams.distance / 2) + v * v);
    const factor = (u, v) => // cos(k * r =
        Math.cos(2 * Math.PI * d1(u, v) / waveParams.waveLength - Math.PI * waveParams.phase / 180) / Math.sqrt(d1(u, v)) +
        Math.cos(2 * Math.PI * d2(u, v) / waveParams.waveLength - Math.PI * waveParams.phase / 180) / Math.sqrt(d2(u, v));
    const surfaceData = {
        parametrization: {
            xFn: (u, v) => u,
            yFn: (u, v) => domain + waveParams.intensity * factor(u, v) * factor(u, v),
            zFn: (u, v) => v
        },
        intervals: [[-domain, domain], [-domain, domain]]
    };

    class ControlsGui {
        constructor(surfaceController, axesController, plot3d) {
            const gui = new GUI({width: "100%", autoPlace: false});

            this._axesController = axesController;
            this._surfaceController = surfaceController;
            this._plot3d = plot3d;

            this.#createAxesFolder(gui);
            this.#createInterferenceFolder(gui);
            document.getElementById("gui-container").appendChild(gui.domElement);
        }

        #updateSurface() {
            this._surfaceController.onSurfaceChange(
                new Surface(
                    new DefaultSurfaceDefinition(
                        new SurfaceSpecification(surfaceData)
                    )
                ),
                surfaceParams
            );
        }

        #createInterferenceFolder(parentFolder) {
            const folder = parentFolder.addFolder("Wave interference");

            folder.add(params.waveParams, "intensity", 0, 5, 0.05)
                .name("Intensity")
                .onChange(() => this.#updateSurface());
            folder.add(params.waveParams, "waveLength", 1, 10, 0.1)
                .name("Wavelength")
                .onChange(() => this.#updateSurface());
            folder.add(params.waveParams, "distance", 1, 40, 0.1)
                .name("Distance")
                .onChange(() => this.#updateSurface());
            folder.add(params.waveParams, "phase", 0, 360, 1)
                .name("Phase")
                .onChange(() => this.#updateSurface());

            folder.open();
        }

        #createAxesFolder(parentFolder) {
            const axesFolder = parentFolder.addFolder("Axes");
            const dummyToggle = {gridPlanes: true};
            axesFolder.add(params.axesParameters, 'frame')
                .name("Frame").onChange(value => axesController.updateSettings());
            axesFolder.add(dummyToggle, 'gridPlanes')
                .name("Layout").onChange(value => {
                params.axesParameters.xyPlane = value;
                params.axesParameters.xzPlane = value;
                params.axesParameters.yzPlane = value;
                axesController.updateSettings();
            });
            axesFolder.add(params.axesParameters, 'annotations')
                .name("Annotations").onChange(value => axesController.updateSettings());
            axesFolder.close();
        }
    }

    const axesParameters = new AxesParameters({annotations: false});
    const surfaceParams = new ViewParameters({
        contourParameters: new ContourParameters({
            contourType: ContourType.NONE
        }),
        tangentFrameParameters: new TangentFrameParameters({
            visible: false
        }),
        opacity: 0.95,
        resolution: 125
    });

    const params = {
        axesParameters: axesParameters,
        waveParams: waveParams
    };
    const axesController = new AxesController({
        parentGroup: worldGroup,
        canvasContainer: canvasContainer,
        axesParameters: params.axesParameters,
        scene: scene
    });

    const defaultSurfaceSpec = new SurfaceSpecification(surfaceData);
    const defaultSurfaceDef = new DefaultSurfaceDefinition(defaultSurfaceSpec);
    const mathSurface = new Surface(defaultSurfaceDef);
    const surfaceController = new SurfaceController(worldGroup, mathSurface, surfaceParams, new HeightColorMapper({useBaseColor: false}));

    // Scale scene according to current surface
    axesController.createFromBoundingBox(surfaceController.surfaceBoundingBox(), false);
    const plot3D = new Plot3DView(scene, canvas, surfaceController.surfaceBoundingBox());
    plot3D.frame(ThreeJsUtils.scaleBox3(surfaceController.surfaceBoundingBox(), .6), {translationY: -2});
    const gui = new ControlsGui(surfaceController, axesController, plot3D);

    // Resizing for mobile devices
    function resize() {
        ThreeJsUtils.resizeRendererToCanvas(plot3D.renderer, plot3D.camera);
        axesController.resize();
    }
    window.addEventListener("resize", resize);
    resize();

    function animate() {
        requestAnimationFrame(animate);
        plot3D.render();
        axesController.render(plot3D.camera);
    }
    animate();
</script>
