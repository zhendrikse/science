<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
      }
    }
</script>

<div class="canvasWrapper" id="polarContainer">
    <canvas class="applicationCanvas" id="polarCanvas"></canvas><br/>
</div>
<div class="gui-container" id="gui-container"></div>

<script type="module">
    import { Vector3, Line, Scene, Color, Group, BufferGeometry, LineBasicMaterial, SphereGeometry, Box3, Mesh,
        MeshStandardMaterial, DoubleSide } from "three";
    import { Plot3DView, AxesParameters, AxesView }
        from 'https://www.hendrikse.name/science/js/three-js-extensions.js';
    import { GUI } from "three/addons/libs/lil-gui.module.min.js";
    import { SurfaceDefinition, TangentFrameView, TangentFrameParameters}
        from "https://www.hendrikse.name/science/js/3d-surface-components.js";

    const canvasContainer = document.getElementById("polarContainer");
    const canvas = document.getElementById("polarCanvas");

    const scene = new Scene();
    scene.background = new Color(0x131313);
    const worldGroup = new Group();
    scene.add(worldGroup);

    const radius = 2;
    const tangentFrameParameters = new TangentFrameParameters({
        u: 45 / 180,
        v: 0 / 360,
        color: "#ff0",
        scale: 1.0,
        showAxes: true,
    });

    const params = {
        tangentFrameParameters: tangentFrameParameters,
        theta: 45,
        phi: 0,
        axesParameters: new AxesParameters({gridPlanes: false, annotations: false, layoutType: AxesView.Type.CLASSICAL})
    };

    class ControlsGui {
        constructor(plot) {
            const gui = new GUI({width: 300, autoPlace: false});

            gui.add(params, "theta", 0, 180, 1)
                .name("θ (theta)")
                .onChange(value => {
                    tangentFrameParameters.u = value / 180;
                    tangentFrame.update(value / 180, tangentFrameParameters.v);
                    const pos = new Vector3();
                    sphereSurface.sample(value / 180, tangentFrameParameters.v, pos);
                    radialLine.geometry.setFromPoints([new Vector3(0, 0, 0), pos]);
                });

            gui.add(params, "phi", 0, 350, 1)
                .name("φ (phi)")
                .onChange(value => {
                    tangentFrameParameters.v = value / 360;
                    tangentFrame.update(tangentFrameParameters.u , value / 360);
                    const pos = new Vector3();
                    sphereSurface.sample(tangentFrameParameters.u, value / 360, pos);
                    radialLine.geometry.setFromPoints([new Vector3(0, 0, 0), pos]);
                });


            const axesFolder = gui.addFolder("Axes");
            axesFolder.add(params.axesParameters, 'axes')
                .name("Axes").onChange(value => plot.applyAxesParameters());
            axesFolder.add(params.axesParameters, 'gridPlanes')
                .name("Layout").onChange(value => plot.applyAxesParameters());
            axesFolder.add(params.axesParameters, 'annotations')
                .name("Annotations").onChange(value => plot.applyAxesParameters());
            axesFolder.close();


            document
                .getElementById("gui-container")
                .appendChild(gui.domElement);
        }
    }

    class SphereSurfaceDefinition extends SurfaceDefinition {
        constructor(radius) {
            super();
            this.radius = radius;
        }

        sample(u, v, target) {
            const theta = u * Math.PI;        // u in [0,1] → theta in [0, π]
            const phi   = -v * 2 * Math.PI;   // v in [0,1] → phi   in [0, 2π]
            const xyz = AxesView.toCartesian(this.radius, theta, phi);
            target.set(xyz.x, xyz.z, xyz.y);
        }
    }

    const sphereSurface = new SphereSurfaceDefinition(radius);
    const tangentFrame = new TangentFrameView(sphereSurface, tangentFrameParameters);
    worldGroup.add(tangentFrame);

    // Radial line
    const position = new Vector3();
    sphereSurface.sample(tangentFrameParameters.u, tangentFrameParameters.v, position);
    const radialLine = new Line(
        new BufferGeometry().setFromPoints([new Vector3(0, 0, 0), position]),
        new LineBasicMaterial({ color: 0xffffff })
    );
    worldGroup.add(radialLine);


    const resolution = 30;
    const geometry = new SphereGeometry( radius, resolution, resolution );
    const material = new MeshStandardMaterial( { side:DoubleSide, color: 0x00ffff, transparent: true, opacity: 0.1, wireframe: true } );
    const sphere = new Mesh( geometry, material );
    sphere.position.set(0, 0, 0);
    worldGroup.add( sphere );

    const boundingBox = new Box3();
    boundingBox.setFromObject( worldGroup );
    const plot3D = new Plot3DView(canvas, canvasContainer, scene, boundingBox, params.axesParameters);

    const gui = new ControlsGui(plot3D);

    function animate() {
        requestAnimationFrame(animate);
        plot3D.render();
    }
    animate();
</script>
