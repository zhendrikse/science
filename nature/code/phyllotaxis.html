<div class="equationDiv" id="flowerEquation"></div>
<div class="canvasWrapper2D" id="canvas-wrapper">
    <canvas class="applicationCanvas2D" id="flowerCanvas"></canvas>
</div>

<label for="cValue"><b>Growth rate</b></label>
<input type="range" id="cValue" min="10" max="20" value="15"
       oninput="c = +this.value; updateEquationDiv(c, n);"/>
<br/><br/>
<button class="button" onclick="setColoringSchemeTo(1)">Colors 1</button>&nbsp;
<button class="button" onclick="setColoringSchemeTo(2)">Colors 2</button>&nbsp;
<button class="button" onclick="setColoringSchemeTo(3)">Colors 3</button>&nbsp;
<button class="button" onclick="setColoringSchemeTo(4)">Monochrome</button>
<br/>&nbsp;<br/>
<label for="borderAroundDots"><b>Border around dots</b></label>
<input type="checkbox" id="borderAroundDots"/>

<script>
    const canvas = document.getElementById("flowerCanvas");
    const wrapper = document.getElementById('canvas-wrapper');
    const display = canvas.getContext("2d");
    canvas.focus();

    let n = 0;
    let c = 15;
    const numberOfDots = 450;
    let coloringSchemeFunction;

    let drawBorderAroundDots = false;
    document.getElementById("borderAroundDots").checked = drawBorderAroundDots;
    document.getElementById("borderAroundDots").addEventListener("click", function(){
        drawBorderAroundDots = !drawBorderAroundDots;
    });

    function setColoringSchemeTo(number) {
        display.clearRect(0, 0, canvas.width, canvas.height);
        n = 0;
        switch (number) {
            case 1:
                coloringSchemeFunction = (angle, radius, n) => {
                    return hsv2rgb((angle - radius) % 360, 1, 1);
                }
                break;
            case 2:
                coloringSchemeFunction = (angle, radius, n) => {
                    return hsv2rgb(n, 1, 1);
                }
                break;
            case 3:
                coloringSchemeFunction = (angle, radius, n) => {
                    return hsv2rgb(angle % 360, 1, 1);
                }
                break;
            case 4:
                coloringSchemeFunction = (angle, radius, n) => {
                    return hsv2rgb(65, 1, 1);
                }
                break;
        }
    }

    function circle(x, y, radius, fillColor="#DDDD00", outline=false) {
        display.fillStyle = fillColor;
        display.strokeStyle = "#000000";
        display.lineWidth = 1;
        display.beginPath();
        display.arc(x, y, radius, 0, Math.PI * 2, true);
        display.closePath();
        display.fill();
        if (outline)
            display.stroke(); // Gives outline to particle

    }

    function hsv2rgb(h, s, v) {
        let f = (n, k = (n + h / 60) % 6) => v - v * s * Math.max( Math.min(k, 4 - k, 1), 0);
        return [f(5), f(3), f(1)];
    }

    function draw(n) {
        const angle = n * 137.5
        const radius = c * Math.sqrt(n);

        const x = radius * Math.cos(Math.PI * angle / 180) + centerX;
        const y = radius * Math.sin(Math.PI * angle / 180) + centerY;

        const colour = coloringSchemeFunction(angle, radius, n);
        const rgb = "rgb(" + 255 * colour[0] + "," + 255 * colour[1] + "," + 255 * colour[2] + ")";
        circle(x, y, 8, rgb, drawBorderAroundDots);
    }

    let centerX = 0, centerY = 0;
    function resizeCanvas() {
        const wrapper = document.getElementById("canvas-wrapper");
        const rectangle = wrapper.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;

        centerX = dpr * rectangle.width * .5;
        centerY = dpr * rectangle.height * .5;

        canvas.width  = Math.floor(rectangle.width * dpr);
        canvas.height = Math.floor(rectangle.height * dpr);

        canvas.style.width  = rectangle.width + "px";
        canvas.style.height = rectangle.height + "px";
    }

    let previousN = n;
    let previousC = c;
    function updateEquationDiv(c, n) {
        if (previousC === c && previousN === n)
            return; // only update equation when parameters have changed

        previousC = c;
        previousN = n;

        const equationDiv = document.getElementById("flowerEquation");
        equationDiv.innerHTML = "$$\\begin{cases} \\phi &= " + n +
            " \\cdot \\frac{137.5\pi}{180}^\\circ \\\\ r &= " + c + "\\sqrt{" + n + "} \\end{cases} \\Rightarrow "+
            " \\begin{cases} x &= r \\cdot \\cos(\\phi) \\\\ y &= r \\cdot \\sin(\\phi) \\end{cases}$$";

        if (window.MathJax?.typesetPromise)
            MathJax.typesetPromise([equationDiv]);

        // if (window.MathJax && mathJaxReady)
        //     MathJax.typesetPromise([equationDiv]);
    }

    window.addEventListener('resize', () => {
        resizeCanvas();
    });

    resizeCanvas();
    setColoringSchemeTo(4);
    //
    // let mathJaxReady = false;
    // function whenMathJaxReady(callback) {
    //     if (window.MathJax && MathJax.startup && MathJax.startup.promise)
    //         MathJax.startup.promise.then(callback);
    //     else
    //         setTimeout(() => whenMathJaxReady(callback), 50);
    // }
    //
    // whenMathJaxReady(() => {
    //     mathJaxReady = true;
    //     updateEquationDiv(c, n);
    // });


    window.requestAnimationFrame(function loop() {
        if (n < numberOfDots)
            draw(n++);

        window.requestAnimationFrame(loop);
    });

</script>
