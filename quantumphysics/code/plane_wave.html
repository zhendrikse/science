<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
      }
    }
</script>

<div class="canvasWrapper" id="planeWaveContainer">
    <canvas class="applicationCanvas" id="planeWaveCanvas"></canvas><br/>
</div>
<div class="guiContainer" id="gui-container"></div>

<script type="module">
    import * as THREE from "three";
    import { Arrow, Axes, AxesParameters, ClassicalAxesLayout, ClassicalAnnotations, Vector, UnitVectorE2 }
        from 'https://www.hendrikse.name/science/js/three-js-extensions.js';
    import { Plot3D }
        from 'https://www.hendrikse.name/science/js/3d-surface-components.js';
    import { GUI } from "three/addons/libs/lil-gui.module.min.js";

    const canvasContainer = document.getElementById("planeWaveContainer");
    const canvas = document.getElementById("planeWaveCanvas");

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x131313);
    const worldGroup = new THREE.Group();
    scene.add(worldGroup);

    const axes = new Axes();
    worldGroup.add(axes);
    const axesLayout = new ClassicalAxesLayout(20, 10);
    axesLayout.hideXY();
    axesLayout.hideYZ();
    const annotations = new ClassicalAnnotations(canvasContainer, 20, 10);
    axes.setLayout(axesLayout);
    axes.setAnnotations(annotations);
    worldGroup.add(annotations);
    annotations.visible = false;

    const plot3D = new Plot3D(canvas, scene, axes);
    const bbox = new THREE.Box3();
    bbox.setFromObject( worldGroup );
    plot3D.fitToBoundingBox(bbox, {padding: 0.7, translationY: -5});

    const params = {
        amplitude: 3,
        omega: 2,
        waveNumber: 0.4,
        axesParameters: new AxesParameters({xyPlane: false, yzPlane: false, axesLabels: false})
    };
    class ControlsGui {
        constructor(axesLayout, annotations, planeWave) {
            const gui = new GUI({width: 300, autoPlace: false});
            gui.add(params, "amplitude", 1, 6, 0.1)
                .name("Amplitude")
                .onChange(value => planeWave.set_amplitude_to(value));
            gui.add(params, "omega", 0, 6, 0.1)
                .name("Omega")
                .onChange(value => planeWave.set_omega_to(value * Math.PI));
            gui.add(params, "waveNumber", -2/3, 2/3, 0.01)
                .name("Wave number k")
                .onChange(value => planeWave.set_k_to(value * Math.PI));

            const axesFolder = gui.addFolder("Axes");
            axesFolder.add(params.axesParameters, 'axesLines')
                .name("Axes").onChange(value => value ? axesLayout.showAxes() : axesLayout.hideAxes());
            axesFolder.add(params.axesParameters, 'axesLabels')
                .name("Axes labels").onChange(value => annotations.visible = value);
            axesFolder.add(params.axesParameters, 'xyPlane')
                .name("XY plane").onChange(value => value ? axesLayout.showXY() : axesLayout.hideXY());
            axesFolder.add(params.axesParameters, 'xzPlane')
                .name("XZ plane").onChange(value => value ? axesLayout.showXZ() : axesLayout.hideXZ());
            axesFolder.add(params.axesParameters, 'yzPlane')
                .name("YZ plane").onChange(value => value ? axesLayout.showYZ() : axesLayout.hideYZ());
            axesFolder.close();

            document
                .getElementById("gui-container")
                .appendChild(gui.domElement);
        }
    }

    class PlaneWave extends THREE.Group {
        constructor(k=2 * Math.PI / 5, omega=2 * Math.PI, amplitude=3) {
            super();
            this._arrows = [];
            for (let x = -10; x < 10; x += 0.3)
                this._arrows.push(new Arrow(new Vector(x, 0, 0), new Vector(0, amplitude, 0), {color: 0xff0000, shaftWidth: 0.03, headLength: 6}));
            this._amplitude = amplitude;
            this._k = k;
            this._omega = omega;
            this._arrows.forEach(arrow => this.add(arrow));
        }

        set_k_to = (value) => this._k = value;

        set_omega_to = (value) =>this._omega = value;

        set_amplitude_to = (value) => this._amplitude = value;

        update(t) {
            this._arrows.forEach(arrow => {
                const x = arrow.position.x;
                const k = this._k;
                const w = this._omega;
                const phase = k * x - w * t;
                let cycles = phase / (2 * Math.PI);
                cycles -= Math.floor(cycles);
                const cphase = 2 * Math.PI * cycles;

                const y = -Math.sin(phase) * this._amplitude;
                const z = -Math.cos(phase) * this._amplitude;
                arrow.updateAxis(new Vector(arrow.axis.x, y, z));
                arrow.updateColor(new THREE.Color().setHSL(1.0 - cphase / (2 * Math.PI), 1.0, 0.5));
            });
        }
    }


    const planeWave = new PlaneWave();
    worldGroup.add(planeWave);
    const gui = new ControlsGui(axesLayout, annotations, planeWave);

    let time = 0;
    const dt = 0.01;
    function animate() {
        requestAnimationFrame(animate);
        plot3D.render();
        planeWave.update(time);
        time += dt;
    }
    animate();
</script>
