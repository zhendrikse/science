<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/"
      }
    }
</script>

<canvas class="applicationCanvas" id="planetsCanvas" style="aspect-ratio: 19 / 12;"></canvas>

<script type="module">
    import { Color, TextureLoader, Scene, PerspectiveCamera, Vector3, WebGLRenderer, AmbientLight,
        PointLight } from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { ThreeJsUtils, Sphere } from 'https://www.hendrikse.name/science/js/three-js-extensions.js';
    import { SkyDome }
        from 'https://www.hendrikse.name/science/js/astro-extensions.js';

    const planetsCanvas = document.getElementById('planetsCanvas');
    planetsCanvas.focus();
    console.clear();

    const gaugeRadius = 10;

    const textureLoader = new TextureLoader();
    textureLoader.setCrossOrigin("anonymous");

    const planetaryScene = new Scene();
    // --- CAMERA ---
    const cameraStart = {
        position: new Vector3(0, 0, gaugeRadius * 2),
        target: new Vector3(0, 0, 0)
    };
    const planetCamera = new PerspectiveCamera(40, 1, .05 * gaugeRadius, 20 * gaugeRadius);
    planetCamera.position.copy(cameraStart.position);

    const planetRenderer = new WebGLRenderer( {antialias: true, canvas: planetsCanvas, alpha: true} );
    planetRenderer.shadowMap.enabled = false;
    planetRenderer.setAnimationLoop( animate );

    // Resizing for mobile devices
    ThreeJsUtils.resizeRendererToCanvas(planetRenderer, planetCamera);
    window.addEventListener('resize', () => {
        ThreeJsUtils.resizeRendererToCanvas(planetRenderer, planetCamera);
    });

    const controls = new OrbitControls(planetCamera, planetsCanvas);
    controls.target.copy(cameraStart.target);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    const skyDome = new SkyDome({starDensity: 1, skyRadius: 18 * gaugeRadius, glowStarCount: 500});
    planetaryScene.add(skyDome);


    const sunLight = new PointLight(0xffffff, 2.0, 0, .1); // intense, no max distance
    sunLight.position.set(0, 0, 0);
    planetaryScene.add(sunLight);
    planetaryScene.add(new AmbientLight(0xffffff, 1));

    const vel0 = new Vector3(0, 0.65, 0);
    const rad = 0.2;
    const size = 0.15;
    const spacing = 0.1;
    const base_angle = 0.2;
    const blackHolePos = new Vector3(-1, 0, 0);

    class Ball {
        constructor(parent, {
            position=new Vector3(0, 0, .5),
            velocity=new Vector3(0, 0, 0),
            radius=1,
            color=0xffff00,
        } = {}) {
            this._sphere = new Sphere(planetaryScene, position, radius, color);
            this._position = position.clone();
            this._velocity = velocity.clone();
            this._rVector = new Vector3();
        }

        update(dt, blackHolePos) {
            this._position.addScaledVector(this._velocity, dt);
            this._sphere.moveTo(this._position);
            this._rVector.subVectors(this._position, blackHolePos);
            const r2 = this._rVector.lengthSq();
            this._rVector.normalize().multiplyScalar(-15.0 / r2);
            this._velocity.addScaledVector(this._rVector, dt);
        }
    }

    class Person {
        constructor(parent) {
            this._balls = [];
            this._head(parent);
            this._body(parent);
            this._rightArm(parent);
            this._leftArm(parent);
            this._rightLeg(parent);
            this._leftLeg(parent);
        }

        _head() {
            this._balls.push(new Ball(planetaryScene, {
                position: new Vector3(10, 1, 0),
                velocity: vel0.clone(),
                radius: 2 * rad,
                color: new Color(0.7, 0.6, 0.5)
            }));
        }

        _body(parent, pos = new Vector3(10, 1.0, 0), colour=new Color(0.2, 0.4, 0.7)) {
            const theta = 0.0;
            for (let i = 0; i < 21; i++) {
                const offset = new Vector3(spacing * i * Math.sin(theta + base_angle), -spacing * i * Math.cos(theta + base_angle), 0);
                this._balls.push(new Ball(parent, {position: pos.clone().add(offset), radius: rad, velocity: vel0.clone(), color: colour}));
            }
        }

        _leftArm(parent, pos = new Vector3(10, 0.7, 0), colour=new Color(0.2, 0.8, 0.9)) {
            const theta = -0.7;
            for (let i = 0; i < 11; i++) {
                const offset = new Vector3(spacing * i * Math.sin(theta + base_angle), -spacing * i * Math.cos(theta + base_angle), 0);
                this._balls.push(new Ball(parent, {position: pos.clone().add(offset), radius: rad, velocity: vel0.clone(), color: colour}));
            }
        }

        _rightArm(parent, pos = new Vector3(10, 0.7, 0), colour=new Color(0.2, 0.8, 0.9)) {
            const theta = 0.7;
            for (let i = 0; i < 11; i++) {
                const offset = new Vector3(spacing * i * Math.sin(theta + base_angle), -spacing * i * Math.cos(theta + base_angle), 0);
                this._balls.push(new Ball(parent, {position: pos.clone().add(offset), radius: rad, velocity: vel0.clone(), color: colour}));
            }
        }

        _rightLeg(parent, colour=new Color(0.2, 0.2, 0.7)) {
            const theta = 0.4;
            const pos = new Vector3(10, 1.0, 0).add((new Vector3(Math.sin(base_angle), -Math.cos(base_angle), 0)).multiplyScalar(2));
            for (let i = 0; i < 11; i++) {
                const offset = new Vector3(spacing * i * Math.sin(theta + base_angle), -spacing * i * Math.cos(theta + base_angle), 0);
                this._balls.push(new Ball(parent, {position: pos.clone().add(offset), radius: rad, velocity: vel0.clone(), color: colour}));
            }
        }

        _leftLeg(parent, colour=new Color(0.2, 0.2, 0.7)) {
            const theta = -0.4;
            const pos = new Vector3(10, 1.0, 0).add((new Vector3(Math.sin(base_angle), -Math.cos(base_angle), 0)).multiplyScalar(2));
            for (let i = 0; i < 11; i++) {
                const offset = new Vector3(spacing * i * Math.sin(theta + base_angle), -spacing * i * Math.cos(theta + base_angle), 0);
                this._balls.push(new Ball(parent, {position: pos.clone().add(offset), radius: rad, velocity: vel0.clone(), color: colour}));
            }
        }

        update(dt, blackHolePos) { this._balls.forEach(ball => ball.update(dt, blackHolePos)); }
    }

    const person = new Person(planetaryScene);
    new Sphere(planetaryScene, blackHolePos, 1.0, new Color(0.3, 0.3, 0.3));

    let lastTime = performance.now() * .001;
    function animate(now) {
        const deltaSeconds = (now - lastTime) * .001;
        lastTime = now;

        person.update(deltaSeconds * 2, blackHolePos);
        skyDome.update(now * .001, planetCamera);
        planetRenderer.render(planetaryScene, planetCamera);
    }

</script>